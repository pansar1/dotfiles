#!/bin/bash
# Sync shared AI configs to tool-specific locations
# This script runs automatically when AI config files change (chezmoi's run_onchange)

set -e

echo "ðŸ¤– Syncing AI configurations..."

AI_CONFIG_DIR="$HOME/.config/ai"
MCP_SERVERS="$AI_CONFIG_DIR/mcp/servers.json"
GLOBAL_INSTRUCTIONS="$AI_CONFIG_DIR/instructions/global.md"

# 0. Sync global instructions to Claude Code CLAUDE.md
if [ -f "$GLOBAL_INSTRUCTIONS" ]; then
    echo "ðŸ“ Syncing global instructions to Claude Code..."
    mkdir -p "$HOME/.claude"
    cp "$GLOBAL_INSTRUCTIONS" "$HOME/.claude/CLAUDE.md"
    echo "   âœ“ Global instructions synced to ~/.claude/CLAUDE.md"
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "âš ï¸  Warning: jq not found. MCP server syncing will be skipped."
    echo "   Install jq with: brew install jq"
    JQ_AVAILABLE=false
else
    JQ_AVAILABLE=true
fi

# 1. Sync MCP servers to Claude Code (merge into ~/.claude.json)
if [ "$JQ_AVAILABLE" = true ] && [ -f "$MCP_SERVERS" ]; then
    echo "ðŸ”Œ Syncing MCP servers to Claude Code..."
    if [ -f "$HOME/.claude.json" ]; then
        # Create backup
        cp "$HOME/.claude.json" "$HOME/.claude.json.backup"

        # Merge mcpServers from shared config into ~/.claude.json
        jq --slurpfile mcp "$MCP_SERVERS" '.mcpServers = $mcp[0].mcpServers' "$HOME/.claude.json" > "$HOME/.claude.json.tmp"
        mv "$HOME/.claude.json.tmp" "$HOME/.claude.json"
        echo "   âœ“ MCP servers synced to ~/.claude.json"
    else
        echo "   âš ï¸  ~/.claude.json not found (Claude Code may not be set up yet)"
    fi
fi

# 2. Sync to Cursor (if installed)
if [ -f "$MCP_SERVERS" ]; then
    if [ -d "$HOME/.cursor" ] || [ -f "$HOME/.cursor/mcp.json" ]; then
        echo "ðŸ”Œ Syncing MCP servers to Cursor..."
        mkdir -p "$HOME/.cursor"
        cp "$MCP_SERVERS" "$HOME/.cursor/mcp.json"
        echo "   âœ“ MCP servers synced to ~/.cursor/mcp.json"
    fi
fi

# 3. Sync to Cline (if installed)
CLINE_DIR="$HOME/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev/settings"
if [ -f "$MCP_SERVERS" ] && [ -d "$CLINE_DIR" ]; then
    echo "ðŸ”Œ Syncing MCP servers to Cline..."
    cp "$MCP_SERVERS" "$CLINE_DIR/cline_mcp_settings.json"
    echo "   âœ“ MCP servers synced to Cline"
fi

# 4. Sync to VS Code Copilot (if installed) - transform format
VSCODE_USER_DIR="$HOME/Library/Application Support/Code/User"
if [ "$JQ_AVAILABLE" = true ] && [ -f "$MCP_SERVERS" ]; then
    if [ -d "$VSCODE_USER_DIR" ]; then
        echo "ðŸ”Œ Syncing MCP servers to VS Code Copilot..."
        # Transform "mcpServers" to "servers" for VS Code format
        jq '{servers: .mcpServers}' "$MCP_SERVERS" > "$VSCODE_USER_DIR/mcp.json"
        echo "   âœ“ MCP servers synced to VS Code Copilot (format transformed)"
    fi
fi

# 5. Sync Skills to Claude Code
SKILLS_DIR="$AI_CONFIG_DIR/skills"
CLAUDE_SKILLS_DIR="$HOME/.claude/skills"
if [ -d "$SKILLS_DIR" ]; then
    echo "ðŸŽ¯ Syncing skills to Claude Code..."
    mkdir -p "$CLAUDE_SKILLS_DIR"

    # Copy each skill directory
    for skill in "$SKILLS_DIR"/*/; do
        if [ -d "$skill" ] && [ -f "$skill/SKILL.md" ]; then
            skill_name=$(basename "$skill")
            mkdir -p "$CLAUDE_SKILLS_DIR/$skill_name"
            cp -r "$skill"* "$CLAUDE_SKILLS_DIR/$skill_name/"
            echo "   âœ“ Synced skill: $skill_name"
        fi
    done
fi

# 6. Sync Skills to Cursor (if installed)
CURSOR_SKILLS_DIR="$HOME/.cursor/skills"
if [ -d "$SKILLS_DIR" ] && [ -d "$HOME/.cursor" ]; then
    echo "ðŸŽ¯ Syncing skills to Cursor..."
    mkdir -p "$CURSOR_SKILLS_DIR"

    for skill in "$SKILLS_DIR"/*/; do
        if [ -d "$skill" ] && [ -f "$skill/SKILL.md" ]; then
            skill_name=$(basename "$skill")
            mkdir -p "$CURSOR_SKILLS_DIR/$skill_name"
            cp -r "$skill"* "$CURSOR_SKILLS_DIR/$skill_name/"
        fi
    done
    echo "   âœ“ Skills synced to Cursor"
fi

# 7. Sync Agents to Claude Code
AGENTS_DIR="$AI_CONFIG_DIR/agents"
CLAUDE_AGENTS_DIR="$HOME/.claude/agents"
if [ -d "$AGENTS_DIR" ]; then
    echo "ðŸ¤– Syncing agents to Claude Code..."
    mkdir -p "$CLAUDE_AGENTS_DIR"

    # Copy each agent file (agents are single .md files, not directories)
    for agent in "$AGENTS_DIR"/*.md; do
        if [ -f "$agent" ]; then
            agent_name=$(basename "$agent")
            # Skip README
            if [ "$agent_name" != "README.md" ]; then
                cp "$agent" "$CLAUDE_AGENTS_DIR/$agent_name"
                echo "   âœ“ Synced agent: ${agent_name%.md}"
            fi
        fi
    done
fi

# 8. Sync Agents to Cursor (if installed)
CURSOR_AGENTS_DIR="$HOME/.cursor/agents"
if [ -d "$AGENTS_DIR" ] && [ -d "$HOME/.cursor" ]; then
    echo "ðŸ¤– Syncing agents to Cursor..."
    mkdir -p "$CURSOR_AGENTS_DIR"

    for agent in "$AGENTS_DIR"/*.md; do
        if [ -f "$agent" ]; then
            agent_name=$(basename "$agent")
            if [ "$agent_name" != "README.md" ]; then
                cp "$agent" "$CURSOR_AGENTS_DIR/$agent_name"
            fi
        fi
    done
    echo "   âœ“ Agents synced to Cursor"
fi

echo "âœ… AI configuration sync complete!"
echo ""
echo "Next steps:"
echo "  â€¢ Restart your AI coding assistants to load new configs"
echo "  â€¢ Edit ~/.config/ai/mcp/servers.json to add MCP servers"
echo "  â€¢ Edit ~/.config/ai/skills/ to add or modify skills"
echo "  â€¢ Edit ~/.config/ai/agents/ to add or modify agents"
echo "  â€¢ Run 'chezmoi apply' to sync changes across machines"
