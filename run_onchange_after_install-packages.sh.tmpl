#!/bin/bash
set -e

BREWFILE_TMPL="{{ .chezmoi.sourceDir }}/Brewfile.tmpl"
BREWFILE_OUT="/tmp/Brewfile.generated"
CHEZMOI="{{ .chezmoi.executable }}"

# Detect Homebrew path (platform-specific)
{{- if eq .chezmoi.os "darwin" }}
{{-   if eq .chezmoi.arch "arm64" }}
BREW_PATH="/opt/homebrew/bin/brew"
{{-   else }}
BREW_PATH="/usr/local/bin/brew"
{{-   end }}
{{- else if eq .chezmoi.os "linux" }}
BREW_PATH="/home/linuxbrew/.linuxbrew/bin/brew"
{{- end }}

# Only proceed if Homebrew is installed
if [[ ! -x "$BREW_PATH" ]]; then
    echo "⚠️  Homebrew not found at $BREW_PATH, skipping package installation"
    exit 0
fi

# Add Homebrew to PATH for this session
eval "$($BREW_PATH shellenv)"

if [[ -f "$BREWFILE_TMPL" ]]; then
    echo "Processing Brewfile template (machine_type={{ .machine_type }})..."
    "$CHEZMOI" execute-template < "$BREWFILE_TMPL" > "$BREWFILE_OUT"
    echo "Installing packages from Brewfile..."
    # Don't fail if some packages are unavailable on this platform
    brew bundle --file="$BREWFILE_OUT" || echo "⚠️  Some packages failed to install (expected on Linux)"
    rm -f "$BREWFILE_OUT"
    echo "✓ Brewfile processed"
fi

if command -v mise &> /dev/null; then
    echo "Installing mise runtimes..."
    mise install
    echo "✓ Mise runtimes installed"
fi
